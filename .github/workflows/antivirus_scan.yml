name: Antivirus scan

on:
  # schedule:
  #   - cron: 0 0 0 0 0
  workflow_dispatch:
    inputs:
      scan_branch:
        type: string
        required: false

jobs:
  compute:
    runs-on: [self-hosted, regular]
    outputs:
      matrix: ${{ steps.compute_matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v6
      - id: compute_matrix
        uses: deckhouse/modules-actions/antivirus_scan/compute_matrix@v8
        with:
          scan_branch: ${{ inputs.scan_branch }}
          active_releases_to_scan: 3
          editions: fe

  scan:
    runs-on: [self-hosted, antivirus]
    needs: compute
    strategy:
      fail-fast: false
      matrix:
        av:
          - name: drweb
            path: drweb
          - name: kaspersky
            path: antivirus
        target: ${{ fromJson(needs.compute.outputs.matrix).include }}
    steps:
      - uses: deckhouse/modules-actions/antivirus_scan/run_scan_module@v8
        id: av_scan
        with:
          tag: ${{ matrix.target.tag }}
          antivirus_name: ${{ matrix.av.name }}
          antivirus_path: ${{ matrix.av.path }}
          scan_results_dir: scans
          module_name: ${{ github.repository }}
          prod_registry: registry.deckhouse.io
          dev_registry: ${{ vars.DEV_REGISTRY }}

      - if: steps.av_scan.outcome == 'success'
        uses: actions/upload-artifact@v6
        with:
          name: scans-${{ matrix.av.name }}-${{ steps.av_scan.outputs.scan_id }}
          path: scans/${{ steps.av_scan.outputs.scan_id }}