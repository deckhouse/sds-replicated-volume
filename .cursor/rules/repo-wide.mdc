---
description: Repository-wide Cursor/agent rules for this repo (formatting, change hygiene, git hygiene, and commit-message conventions). Apply when working in this repository (any task), especially when making or explaining changes, planning a sequence of edits, or preparing commits. Apply when editing relevant files, and when reasoning/planning/answering questions where this rule could influence code decisions (even if matching files are not currently open).
alwaysApply: true
---

- Formatting & style (MUST):
  - Match existing formatting and indentation exactly.

- License headers (MUST):
  - Each manually written source code file (not produced by code generators, not copied from other repositories) MUST have a license header at the top.
  - Use the template from `hack/boilerplate.txt`.
  - Replace `YEAR` with the current year (based on system time) when creating a new file.
  - Once set, the year MUST NOT be changed in subsequent edits to the file.

- Change hygiene / cleanup (MUST):
  - If I create a file and later replace it with a correct alternative, I MUST remove the now-invalid file(s) in the same change.

- Dialogue adherence (MUST):
  - User answers are authoritative context.
  - If I ask a question and receive an answer, subsequent actions MUST align with that answer and MUST NOT contradict or ignore it.

- File moves/renames (MUST):
  - When moving or renaming files, preserve Git history by using `git mv` (or an equivalent Git-aware rename).
  - Do NOT implement a move as "create new file + delete old file".

- Git commit messages (MUST):
  - When the user asks you to generate a commit message, ALWAYS output the commit message in a copy-friendly code block.
  - When the user asks you to generate a commit message, ALWAYS remind about sign-off as plain text AFTER the commit message (do NOT put the reminder inside the commit message body). Prefer: `Don't forget to sign off` and suggest `git commit -s`.
  - Use English for commit messages.
  - Prefer prefixing the subject with a component in square brackets, e.g. `[controller] Fix ...`, `[api] Add ...`.
  - If the change is non-trivial, add a short body listing the key changes; for small changes, the subject alone is enough.
  - When generating a commit message, consider the full diff (don’t skimp on context), including:
    - Staged/cached changes (index)
    - Contents of deleted files

- When making a commit (MUST):
  - ALWAYS sign off (prefer `git commit -s`).
  - Do NOT add `Co-authored-by`, `Authored-by`, or any other trailer signatures. The only valid signature is `Signed-off-by` with user credentials.

- API development / design / review (MUST):
  - When developing, designing, or reviewing API types under `api/v*/`, you MUST consult and follow the API-specific `.mdc` rules in `.cursor/rules/`:
    - `api-file-structure.mdc` — API package conventions: object prefixes and per-object/common file naming rules.
    - `api-types.mdc` — API type rules: type-centric layout, enums/constants, status/conditions requirements, naming.
    - `api-conditions.mdc` — API condition Type/Reason constants naming, ordering, comments, and stability.
    - `api-labels-and-finalizers.mdc` — API naming rules for label keys and finalizer constants.
    - `api-codegen.mdc` — API codegen rules for kubebuilder/controller-gen and generated files hygiene.
  - You SHOULD also consult `controller-terminology.mdc` for shared terminology (intended/actual/target/report, patch domains, etc.) that applies to API design.
  - Each rule file has a `description` in its frontmatter indicating when to apply it.
  - When in doubt, start with `api-file-structure.mdc` for where code belongs and `api-types.mdc` for type layout conventions.

- Controller development / design / review (MUST):
  - When developing, designing, or reviewing controllers under `images/controller/internal/controllers/`, you MUST consult and follow the controller-specific `.mdc` rules in `.cursor/rules/`:
    - `controller-terminology.mdc` — shared terminology and definitions used across all controller rule files.
    - `controller-file-structure.mdc` — controller package file structure (`controller.go`/`predicates.go`/`reconciler.go`/tests).
    - `controller-controller.mdc` — rules for `controller.go` (wiring, builder chain, predicates wiring).
    - `controller-predicate.mdc` — rules for `predicates.go` (mechanical change detection, no I/O, no domain logic).
    - `controller-reconciliation.mdc` — rules for `Reconcile` method orchestration in `reconciler.go`.
    - `controller-reconciliation-flow.mdc` — rules for using `lib/go/common/reconciliation/flow` (phases, outcomes).
    - `controller-reconcile-helper.mdc` — common rules for ReconcileHelper functions/methods.
    - `controller-reconcile-helper-*.mdc` — category-specific contracts (compute, apply, ensure, get, create, delete, patch, is-in-sync, construction).
  - Each rule file has a `description` and optional `globs` in its frontmatter indicating when to apply it.
  - When in doubt, start with `controller-terminology.mdc` for definitions and `controller-file-structure.mdc` for where code belongs.
