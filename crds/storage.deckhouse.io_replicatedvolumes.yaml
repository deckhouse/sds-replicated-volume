---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.19.0
  labels:
    module: sds-replicated-volume
  name: replicatedvolumes.storage.deckhouse.io
spec:
  group: storage.deckhouse.io
  names:
    kind: ReplicatedVolume
    listKind: ReplicatedVolumeList
    plural: replicatedvolumes
    shortNames:
    - rv
    singular: replicatedvolume
  scope: Cluster
  versions:
  - additionalPrinterColumns:
    - jsonPath: .status.conditions[?(@.type=='IOReady')].status
      name: IOReady
      type: string
    - jsonPath: .spec.size
      name: Size
      type: string
    - jsonPath: .status.actualSize
      name: ActualSize
      type: string
    - jsonPath: .status.diskfulReplicaCount
      name: DiskfulReplicas
      type: string
    - jsonPath: .status.phase
      name: Phase
      type: string
    name: v1alpha1
    schema:
      openAPIV3Schema:
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            properties:
              replicatedStorageClassName:
                minLength: 1
                type: string
              size:
                anyOf:
                - type: integer
                - type: string
                pattern: ^(\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))))?$
                x-kubernetes-int-or-string: true
            required:
            - replicatedStorageClassName
            - size
            type: object
          status:
            properties:
              actuallyAttachedTo:
                items:
                  type: string
                maxItems: 2
                type: array
              conditions:
                items:
                  description: Condition contains details for one aspect of the current
                    state of this API Resource.
                  properties:
                    lastTransitionTime:
                      description: |-
                        lastTransitionTime is the last time the condition transitioned from one status to another.
                        This should be when the underlying condition changed.  If that is not known, then using the time when the API field changed is acceptable.
                      format: date-time
                      type: string
                    message:
                      description: |-
                        message is a human readable message indicating details about the transition.
                        This may be an empty string.
                      maxLength: 32768
                      type: string
                    observedGeneration:
                      description: |-
                        observedGeneration represents the .metadata.generation that the condition was set based upon.
                        For instance, if .metadata.generation is currently 12, but the .status.conditions[x].observedGeneration is 9, the condition is out of date
                        with respect to the current state of the instance.
                      format: int64
                      minimum: 0
                      type: integer
                    reason:
                      description: |-
                        reason contains a programmatic identifier indicating the reason for the condition's last transition.
                        Producers of specific condition types may define expected values and meanings for this field,
                        and whether the values are considered a guaranteed API.
                        The value should be a CamelCase string.
                        This field may not be empty.
                      maxLength: 1024
                      minLength: 1
                      pattern: ^[A-Za-z]([A-Za-z0-9_,:]*[A-Za-z0-9_])?$
                      type: string
                    status:
                      description: status of the condition, one of True, False, Unknown.
                      enum:
                      - "True"
                      - "False"
                      - Unknown
                      type: string
                    type:
                      description: type of condition in CamelCase or in foo.example.com/CamelCase.
                      maxLength: 316
                      pattern: ^([a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*/)?(([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])$
                      type: string
                  required:
                  - lastTransitionTime
                  - message
                  - reason
                  - status
                  - type
                  type: object
                type: array
                x-kubernetes-list-map-keys:
                - type
                x-kubernetes-list-type: map
              configuration:
                description: Configuration is the desired configuration snapshot for
                  this volume.
                properties:
                  replication:
                    description: Replication is the resolved replication mode.
                    type: string
                  storagePoolName:
                    description: StoragePoolName is the name of the ReplicatedStoragePool
                      used by this RSC.
                    type: string
                  topology:
                    description: Topology is the resolved topology setting.
                    type: string
                  volumeAccess:
                    description: VolumeAccess is the resolved volume access mode.
                    type: string
                required:
                - replication
                - storagePoolName
                - topology
                - volumeAccess
                type: object
              configurationGeneration:
                description: ConfigurationGeneration is the RSC generation from which
                  configuration was taken.
                format: int64
                type: integer
              configurationObservedGeneration:
                description: ConfigurationObservedGeneration is the RSC generation
                  when configuration was last observed/acknowledged.
                format: int64
                type: integer
              datamesh:
                description: Datamesh is the computed datamesh configuration for the
                  volume.
                properties:
                  allowTwoPrimaries:
                    default: false
                    description: AllowTwoPrimaries enables two primaries mode for
                      the datamesh.
                    type: boolean
                  members:
                    description: Members is the list of datamesh members.
                    items:
                      description: ReplicatedVolumeDatameshMember represents a member
                        of the datamesh.
                      properties:
                        addresses:
                          description: Addresses is the list of DRBD addresses for
                            this member.
                          items:
                            properties:
                              address:
                                properties:
                                  ipv4:
                                    pattern: ^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$
                                    type: string
                                  port:
                                    maximum: 65535
                                    minimum: 1025
                                    type: integer
                                required:
                                - ipv4
                                - port
                                type: object
                              systemNetworkName:
                                maxLength: 64
                                type: string
                            required:
                            - address
                            - systemNetworkName
                            type: object
                          maxItems: 16
                          minItems: 1
                          type: array
                        lvmVolumeGroupName:
                          description: LVMVolumeGroupName is the LVMVolumeGroup resource
                            name where this replica should be placed.
                          minLength: 1
                          pattern: ^[a-z0-9]([a-z0-9-.]{0,251}[a-z0-9])?$
                          type: string
                        lvmVolumeGroupThinPoolName:
                          description: LVMVolumeGroupThinPoolName is the thin pool
                            name (for LVMThin storage pools).
                          type: string
                        name:
                          description: |-
                            Name is the member name (used as list map key).
                            Must have format "prefix-N" where N is 0-31.
                          minLength: 1
                          type: string
                        nodeName:
                          description: NodeName is the Kubernetes node name where
                            the member is located.
                          minLength: 1
                          type: string
                        role:
                          description: Role is the DRBD role of this member.
                          type: string
                        type:
                          description: Type is the member type (Diskful, Access, or
                            TieBreaker).
                          type: string
                        typeTransition:
                          description: TypeTransition indicates the desired type transition
                            for this member.
                          enum:
                          - ToDiskful
                          - ToDiskless
                          type: string
                        zone:
                          description: Zone is the zone where the member is located.
                          type: string
                      required:
                      - addresses
                      - name
                      - nodeName
                      - type
                      type: object
                      x-kubernetes-validations:
                      - message: Diskful can only have ToDiskless typeTransition
                        rule: self.type != 'Diskful' || !has(self.typeTransition)
                          || self.typeTransition == 'ToDiskless'
                      - message: TieBreaker can only have ToDiskful typeTransition
                        rule: self.type != 'TieBreaker' || !has(self.typeTransition)
                          || self.typeTransition == 'ToDiskful'
                      - message: Access cannot have typeTransition
                        rule: self.type != 'Access' || !has(self.typeTransition)
                      - message: name must contain '-' separator
                        rule: self.name.lastIndexOf('-') >= 0
                      - message: name numeric suffix must be between 0 and 31
                        rule: int(self.name.substring(self.name.lastIndexOf('-') +
                          1)) <= 31
                      - message: lvmVolumeGroupName can only be set for Diskful type
                          or when typeTransition is ToDiskful
                        rule: size(self.lvmVolumeGroupName) == 0 || self.type == 'Diskful'
                          || (has(self.typeTransition) && self.typeTransition == 'ToDiskful')
                      - message: lvmVolumeGroupThinPoolName requires lvmVolumeGroupName
                          to be set
                        rule: size(self.lvmVolumeGroupThinPoolName) == 0 || size(self.lvmVolumeGroupName)
                          > 0
                    maxItems: 24
                    type: array
                    x-kubernetes-list-map-keys:
                    - name
                    x-kubernetes-list-type: map
                  quorum:
                    default: 0
                    description: Quorum is the quorum value for the datamesh.
                    maximum: 13
                    minimum: 0
                    type: integer
                  quorumMinimumRedundancy:
                    default: 0
                    description: QuorumMinimumRedundancy is the minimum redundancy
                      required for quorum.
                    maximum: 8
                    minimum: 0
                    type: integer
                  sharedSecret:
                    description: SharedSecret is the shared secret for DRBD authentication.
                    maxLength: 256
                    type: string
                  sharedSecretAlg:
                    description: SharedSecretAlg is the hashing algorithm for the
                      shared secret.
                    enum:
                    - SHA256
                    - SHA1
                    - DummyForTest
                    type: string
                  size:
                    anyOf:
                    - type: integer
                    - type: string
                    description: Size is the desired size of the volume.
                    pattern: ^(\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))))?$
                    x-kubernetes-int-or-string: true
                  systemNetworkNames:
                    description: SystemNetworkNames is the list of system network
                      names for DRBD communication.
                    items:
                      maxLength: 64
                      type: string
                    maxItems: 16
                    type: array
                required:
                - allowTwoPrimaries
                - members
                - quorum
                - quorumMinimumRedundancy
                - size
                - systemNetworkNames
                type: object
              datameshRevision:
                description: DatameshRevision is a counter incremented when datamesh
                  configuration changes.
                format: int64
                type: integer
              desiredAttachTo:
                description: |-
                  DesiredAttachTo is the desired set of nodes where the volume should be attached (up to 2 nodes).
                  It is computed by controllers from ReplicatedVolumeAttachment (RVA) objects.
                items:
                  type: string
                maxItems: 2
                type: array
              drbd:
                properties:
                  config:
                    properties:
                      allowTwoPrimaries:
                        default: false
                        type: boolean
                    type: object
                type: object
              eligibleNodesViolations:
                description: EligibleNodesViolations lists replicas placed on non-eligible
                  nodes.
                items:
                  description: ReplicatedVolumeEligibleNodesViolation describes a
                    replica placed on a non-eligible node.
                  properties:
                    nodeName:
                      description: NodeName is the node where the replica is placed.
                      type: string
                    reason:
                      description: Reason describes why this placement violates eligible
                        nodes constraints.
                      type: string
                    replicaName:
                      description: ReplicaName is the ReplicatedVolumeReplica name.
                      type: string
                  required:
                  - nodeName
                  - reason
                  - replicaName
                  type: object
                type: array
            required:
            - datamesh
            - datameshRevision
            type: object
        required:
        - metadata
        - spec
        type: object
        x-kubernetes-validations:
        - message: metadata.name must be at most 120 characters (to fit derived RVR/LLV
            names)
          rule: size(self.metadata.name) <= 120
    served: true
    storage: true
    subresources:
      status: {}
