# Соответствие спецификации для `rvr-status-config-node-id-controller`

> **Примечание:** Этот контроллер соответствует стандартам проекта, описанным в [`CONTROLLER_STYLE_GUIDE.md`](../CONTROLLER_STYLE_GUIDE.md).

## Спецификация (из `docs/dev/spec_v1alpha3.md`)

### Цель
Проставить свойству `rvr.status.drbd.config.nodeId` уникальное значение среди всех реплик одной RV, в диапазоне [0; 7].

В случае превышения количества реплик, повторять реконсайл с ошибкой.

### Триггер
- `CREATE(RVR, status.drbd.config.nodeId==nil)`

### Вывод
- `rvr.status.drbd.config.nodeId`

---


## Таблица соответствия

| Требование | Статус | Тесты |
|-----------|--------|-------|
| Уникальный `nodeId` в диапазоне [0; 7] | ✅ | ✅ `assigns nodeID to first replica`, `assigns nodeID sequentially` |
| Проверка превышения количества реплик | ✅ | ✅ `returns error when all nodeIDs are used` |
| Возврат ошибки при превышении | ✅ | ✅ `returns error when all nodeIDs are used` |
| Триггер `CREATE(RVR, status.drbd.config.nodeId==nil)` | ✅ | ✅ Все тесты с созданием RVR, `when rvr has nil Status/DRBD/Config/NodeId` |
| Вывод `rvr.status.drbd.config.nodeId` | ✅ | ✅ Все тесты проверяют установку nodeID |
| Заполнение пустых мест | ✅ | ✅ `fills gaps in nodeIDs` |
| Не переприсваивать если уже установлено | ✅ | ✅ `does not reassign nodeID if already assigned` |
| Разные volumes независимы | ✅ | ✅ `isolates nodeIDs by volume` |
| Сброс невалидного nodeID | ⚠️ | ✅ `logs error and reassigns`, `ignores nodeID outside valid range`, `resets invalid nodeID and reassigns valid one` |
| Обработка ошибок Get | ⚠️ | ✅ `should fail if getting ReplicatedVolumeReplica failed with non-NotFound error` |
| Обработка ошибок List | ⚠️ | ✅ `should fail if listing replicas failed` |
| Обработка ошибок Patch | ⚠️ | ✅ `should fail if patching ReplicatedVolumeReplica status failed with non-NotFound error` |
| Освобождение nodeID после удаления | ⚠️ | ✅ `returns error when all nodeIDs are used and assigns freed nodeID after deletion` |
| Работа в несколько потоков | ⚠️ | ✅ Неявно (через PatchStatusWithConflictRetry) |


## Схема логики работы контроллера

```
┌─────────────────────────────────────────────────────────────────┐
│                    Триггеры контроллера                         │
├─────────────────────────────────────────────────────────────────┤
│ CREATE/UPDATE/DELETE/Generic(RVR) - все события обрабатываются  │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Reconcile()                                │
├─────────────────────────────────────────────────────────────────┤
│ 1. Получить RVR по req.NamespacedName                           │
│ 2. Проверить: nodeId установлен?                                │
└─────────────────────────────────────────────────────────────────┘
                            │
                ┌───────────┴───────────┐
                │                       │
                ▼                       ▼
    ┌───────────────────┐   ┌──────────────────────────┐
    │ nodeId валидный?  │   │ nodeId не установлен     │
    └───────────────────┘   └──────────────────────────┘
                │                       │
        ┌───────┴───────┐               │
        │               │               │
        ▼               ▼               ▼
┌──────────────┐ ┌──────────────┐ ┌──────────────────────────────┐
│ return       │ │ Сбросить     │ │ Получить все RVR для того же │
│ (не изменять)│ │ невалидный   │ │ ReplicatedVolume             │
└──────────────┘ │ nodeID       │ └──────────────────────────────┘
                 └──────────────┘               │
                            │                   ▼
                            └───────────► ┌──────────────────────────────┐
                                          │ Собрать занятые nodeIDs (0-7)│
                                          │ (игнорировать невалидные)    │
                                          └──────────────────────────────┘
                                                      │
                                  ┌───────────────────┴───────────────────┐
                                  │                                       │
                                  ▼                                       ▼
                      ┌──────────────────────┐          ┌────────────────────┐
                      │ totalReplicas > 8?   │          │ totalReplicas <= 8 │
                      └──────────────────────┘          └────────────────────┘
                                  │                                       │
                                  ▼                                       ▼
                      ┌──────────────────────┐      ┌──────────────────────────┐
                      │ log.Error()          │      │ Найти доступный nodeID   │
                      │ return ErrInvalid    │      │ (0-7, заполняя пропуски) │
                      └──────────────────────┘      └──────────────────────────┘
                                                              │
                                              ┌───────────────┴───────────────┐
                                              │                               │
                                              ▼                               ▼
                                  ┌───────────────────────┐      ┌───────────────────────┐
                                  │ availableNodeID == nil│      │ availableNodeID найден│
                                  └───────────────────────┘      └───────────────────────┘
                                              │                               │
                                              ▼                               ▼
                              ┌──────────────────────┐        ┌──────────────────────────┐
                              │ log.Error()          │        │ PatchStatusWithConflict  │
                              │ return ErrInvalid    │        │ Retry()                  │
                              └──────────────────────┘        │ 1. Проверить nodeId снова│
                                                              │    (не изменять если есть)│
                                                              │ 2. Инициализировать      │
                                                              │    status если нужно     │
                                                              │ 3. Установить nodeID     │
                                                              └──────────────────────────┘
                                                                          │
                                                                          ▼
                                                              ┌──────────────────────────┐
                                                              │ return (success)         │
                                                              └──────────────────────────┘
```

---

## Итоги

1. **Соответствие спецификации:** Полностью соответствует требованиям.

2. **Дополнительные возможности:**
   - Сброс невалидного nodeID: Если nodeID вне диапазона [0; 7], он сбрасывается и переназначается
   - Логирование ошибок: Для диагностики
   - Работа в несколько потоков: Через `PatchStatusWithConflictRetry`

3. **Тестирование:**
   - Используется **Ginkgo/Gomega**
   - Покрытие кода: 89.7%
