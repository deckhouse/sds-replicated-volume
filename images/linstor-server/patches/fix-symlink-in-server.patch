From fed1543400188d8897ec228f0e4214e911778efe Mon Sep 17 00:00:00 2001
From: "v.oleynikov" <vasily.oleynikov@flant.com>
Date: Wed, 6 Nov 2024 17:32:56 +0300
Subject: [PATCH] Fix symlinks in server

---
 .../linstor/storage/utils/Commands.java       |   9 ++
 .../linstor/storage/utils/DmSetupUtils.java   | 142 ++++++++++++++++++
 2 files changed, 151 insertions(+)
 create mode 100644 server/src/main/java/com/linbit/linstor/storage/utils/DmSetupUtils.java

diff --git a/server/src/main/java/com/linbit/linstor/storage/utils/Commands.java b/server/src/main/java/com/linbit/linstor/storage/utils/Commands.java
index cad3b37ba..0e77914e0 100644
--- a/server/src/main/java/com/linbit/linstor/storage/utils/Commands.java
+++ b/server/src/main/java/com/linbit/linstor/storage/utils/Commands.java
@@ -10,6 +10,7 @@ import com.linbit.extproc.ExtCmd.OutputData;
 import com.linbit.extproc.ExtCmdUtils;
 import com.linbit.linstor.storage.StorageException;
 import com.linbit.utils.StringUtils;
+import com.linbit.storage.utils.DmSetupUtils;

 import java.io.IOException;
 import java.util.ArrayList;
@@ -170,6 +171,14 @@ public class Commands
     )
         throws StorageException
     {
+
+        if (!Files.exists(Paths.get(devicePath))) {
+          DateTimeFormatter dtf = DateTimeFormatter.ofPattern("yyyy/MM/dd/HH:mm:ss:SSS");
+          LocalDateTime now = LocalDateTime.now();
+          System.out.println(dtf.format(now) + " [GetBlockSizeInKib] WARN - Device path " + devicePath + " does not exist, fixing symlink");
+          DmSetupUtils.fixSymlinkForDevice(extCmd, devicePath);
+        }
+
         OutputData output = genericExecutor(
             extCmd,
             new String[]
diff --git a/server/src/main/java/com/linbit/linstor/storage/utils/DmSetupUtils.java b/server/src/main/java/com/linbit/linstor/storage/utils/DmSetupUtils.java
new file mode 100644
index 000000000..06fab631c
--- /dev/null
+++ b/server/src/main/java/com/linbit/linstor/storage/utils/DmSetupUtils.java
@@ -0,0 +1,142 @@
+package com.linbit.linstor.storage.utils.dmsetuputils;
+
+import com.linbit.extproc.ExtCmd;
+import com.linbit.extproc.ExtCmd.OutputData;
+import com.linbit.linstor.storage.StorageException;
+import java.util.regex.Pattern;
+import java.io.File;
+import java.io.IOException;
+import java.io.UncheckedIOException;
+import java.nio.file.FileSystems;
+import java.nio.file.Files;
+import java.nio.file.Path;
+import java.nio.file.Paths;
+import java.nio.file.attribute.FileAttribute;
+import java.nio.file.attribute.PosixFilePermission;
+import java.nio.file.attribute.PosixFilePermissions;
+
+
+public  class DmSetupUtils
+{
+    private static final Pattern DM_SETUP_LS_PATTERN = Pattern.compile(
+            "^([^\\s]+)\\s+\\(([0-9]+)[:,]\\s*([0-9]+)\\)$",
+            Pattern.MULTILINE
+        );
+
+    public static void fixSymlinkForDevice(ExtCmd extCmd, String devicePath) throws StorageException
+    {
+        try
+        {
+            OutputData outputData = extCmd.exec("dmsetup", "ls");
+            ExtCmdUtils.checkExitCode(
+                outputData,
+                StorageException::new,
+                "listing devices from dmsetup ls failed "
+            );
+
+            String stdOut = new String(outputData.stdoutData);
+            Matcher matcher = DM_SETUP_LS_PATTERN.matcher(stdOut);
+            String dmName = resolveDMName(devicePath);
+            String dmPath = "/dev/mapper/" + dmName;
+            String minor = null;
+
+            while (matcher.find())
+            {
+                String devName = matcher.group(1);
+                minor = matcher.group(3);
+
+                if (devName.equals(dmName))
+                {
+                    break;
+                }
+            }
+            if (minor == null)
+            {
+                throw new StorageException(
+                    "Device \"" + dmName + "\" (generated from \"" + devicePath + "\") not found in dmsetup output:\n\n" + stdOut
+                );
+            }
+
+            for (String path : new String[]{devicePath, dmPath}) {
+                if (Files.exists(Paths.get(path))) {
+                    continue;
+                }
+
+                System.out.println("Symbolic link \"" + path + "\" does not exist. Proceeding to create it.");
+
+                // ------- create dir ------
+                Path dirPath = Paths.get(path).getParent();
+
+                if (!Files.exists(dirPath)) {
+                    Set<PosixFilePermission> permissions = PosixFilePermissions.fromString("rwxr-xr-x");
+                    FileAttribute<Set<PosixFilePermission>> fileAttributes = PosixFilePermissions.asFileAttribute(permissions);
+                    Files.createDirectory(dirPath, fileAttributes);
+                    System.out.println("Directory \"" + dirPath + "\" successfully created with permissions 'rwxr-xr-x'.");
+               } else {
+                    System.out.println("Directory \"" + dirPath + "\" already exists.");
+                }
+                // ------- create dir ---------
+                // ------- create symlink -----
+
+                Path originFileRelativePath = Paths.get("../dm-" + minor);
+                File originFile = new File("/dev/dm-" + minor);
+
+
+                if (originFile.exists()) {
+                    System.out.println("Origin file  \"" + originFile + "\" found. Proceeding to create a symlink.");
+                        Path newLink = FileSystems.getDefault().getPath(path);
+
+                    try {
+                        Files.createSymbolicLink(newLink, originFileRelativePath);
+                        System.out.println("Symlink \"" + newLink + "\" created, pointing to \"" + originFileRelativePath + "\"");
+                    }
+                    catch (IOException e) {
+                        System.err.println(e);
+                    }
+                    catch (UncheckedIOException e) {
+                        System.err.println(e);
+                    }
+                } else {
+                    System.out.println("Origin file \"" + originFile + "\" not found. Unable to create symbolic link");
+                }
+
+                // ------- create symlink -----
+
+
+
+                // OutputData symlinkOutput = extCmd.exec("ln", "-s", "../dm-" + minor, path);
+                // ExtCmdUtils.checkExitCode(
+                //     symlinkOutput,
+                //     StorageException::new,
+                //     "Failed to create device symlink"
+                // );
+            }
+        }
+        catch (IOException ioExc)
+        {
+            throw new StorageException(
+                "Failed to fix device symlink",
+                ioExc
+            );
+        }
+        catch (ChildProcessTimeoutException exc)
+        {
+            throw new StorageException(
+                "Fixing device symlink timed out",
+                exc
+            );
+        }
+    }
+
+    public static String resolveDMName(String devicePath)
+    {
+        String[] parts = devicePath.replaceFirst("^/dev/", "").split("/");
+        if (parts[0].equals("mapper"))
+        {
+            return parts[1];
+        }
+        parts[0] = parts[0].replace("-", "--");
+        parts[1] = parts[1].replace("-", "--");
+        return String.join("-", parts[0], parts[1]);
+    }
+}
--
2.43.0
