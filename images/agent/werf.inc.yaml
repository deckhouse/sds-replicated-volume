---
# do not remove this image: used in external audits (DKP CSE)
image: {{ .ImageName }}-src-artifact
fromImage: builder/src
final: false
git:
  - add: /
    to: /src
    includePaths:
      - api
      - lib/go
      - images/{{ $.ImageName }}
    stageDependencies:
      install:
        - '**/*'
    excludePaths:
      - images/{{ $.ImageName }}/werf.yaml
shell:
  install:
    - git clone --depth 1 --branch v{{ include "get_oss_version_by_id" (list "DRBD_UTILS" $.Root) }} {{ $.Root.SOURCE_REPO }}/LINBIT/drbd-utils /src/drbd-utils
    - cd /src/drbd-utils
    - git submodule update --init --recursive
    #- rm -rf /src/drbd-utils/.git # needed for make
    # LVM2
    - git clone --depth 1 --branch v{{ include "get_oss_version_by_id" (list "LVM2" $.Root) }} {{ $.Root.SOURCE_REPO }}/lvmteam/lvm2.git /src/lvm2
    - rm -rf /src/lvm2/.git


---
{{- $drbdBinaries := "/drbd-utils/sbin/* /drbd-utils/etc/drbd.conf /drbd-utils/etc/drbd.d/global_common.conf /drbd-utils/etc/multipath/conf.d/drbd.conf /usr/sbin/dmsetup /usr/sbin/dmstats" }}
image: {{ .ImageName }}-binaries-artifact
fromImage: builder/alt
final: false
import:
  - image: {{ .ImageName }}-src-artifact
    add: /src
    to: /src
    includePaths:
      - drbd-utils
      - lvm2
    before: install
git:
  - add: /tools/dev_images/additional_tools/alt/binary_replace.sh
    to: /binary_replace.sh
    stageDependencies:
      beforeSetup:
        - '**/*'
shell:
  beforeInstall:
    - apt-get update
    - apt-get install -y make automake pkg-config gcc libtool git curl rsync
    - apt-get install -y flex libkeyutils-devel udev
    - {{ $.Root.ALT_CLEANUP_CMD }}
  install:
    - cd /src/drbd-utils
    - ./autogen.sh
    - ./configure --prefix=/ --sysconfdir=/etc --localstatedir=/var --without-manual
      # Fix the command startup error:
      # 'git rev-parse HEAD'
      # fatal: not a git repository (or any of the parent directories): .git
    - if ! test -e .git/refs;then echo "-- mkdir -p .git/refs" ;mkdir -p .git/refs ;fi
    - make
    - make install DESTDIR=/drbd-utils
    - sed -i 's/usage-count\s*yes;/usage-count no;/' /drbd-utils/etc/drbd.d/global_common.conf
    # LVM2 - Let's take only dmsetup
    - cd /src/lvm2
    - ./configure --prefix=/ --libdir=/lib64 --build=x86_64-linux-gnu --disable-readline --without-systemd
    - make libdm.device-mapper
    - make -C libdm install_device-mapper
  beforeSetup:
    - chmod +x /binary_replace.sh
    - /binary_replace.sh -i "{{ $drbdBinaries }}" -o /relocate
  setup:
    - rsync -avz /relocate/drbd-utils/ /relocate/
    - rm -rf /relocate/drbd-utils/

---
image: {{ .ImageName }}-golang-artifact
fromImage: builder/golang-alpine
final: false
import:
  - image: {{ .ImageName }}-src-artifact
    add: /src
    to: /src
    excludePaths:
      - drbd-utils
    before: setup
mount:
  - fromPath: ~/go-pkg-cache
    to: /go/pkg
shell:
  setup:
    - cd /src/images/{{ $.ImageName }}/cmd
    - GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -ldflags="-s -w" -tags {{ $.Root.MODULE_EDITION }} -o /{{ $.ImageName }}
    - chmod +x /{{ $.ImageName }}

---
image: {{ .ImageName }}
fromImage: builder/src
import:
  - image: {{ $.ImageName }}-binaries-artifact
    add: /relocate
    to: /
    before: setup
  - image: {{ $.ImageName }}-golang-artifact
    add: /{{ $.ImageName }}
    to: /{{ $.ImageName }}
    before: setup
imageSpec:
  config:
    entrypoint: ["/{{ $.ImageName }}"]
