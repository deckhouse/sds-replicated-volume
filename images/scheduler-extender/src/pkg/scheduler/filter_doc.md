# Scheduler Extender

Работа с подрами осуществляется двумя эндпоинтами - /filter и /prioritize

## /filter
Задача эндпоинта - отфильтровать неподходищие для назначения пода ноды и вернуть список подходящих.

## Алгоритм работы:

1. Метод принимает HTTP-запрос и десериализует его в структуру ExtenderArgs:

```go
type ExtenderArgs struct {
	Pod *apiv1.Pod `json:"pod"`
	Nodes *apiv1.NodeList `json:"nodes,omitempty"`
	NodeNames *[]string `json:"nodenames,omitempty"`
}
```
Pod - под, который ожидает назначения на ноду
NodeNames - имено нод-кандидатов, на которых под может быть размещен
В текущей реализации логики непустым будет только поле NodeNames. Nodes не используется.

2. Если поле Pod == nil, на клиент возвращается ошибка
3. Имена нод-кандидатов извлекаются из ExtenderArgs методом getNodeNames()
4. С помощью функции shouldProcessPod() определяется нужно ли обрабатывать данный под:
    - метод итерирует по всем томам пода (shouldProcessPod)
    - для каждого тома находит связанную с ним pvc
    - на основании данных pvc метод определяет кто является ее provisioner
    - для продолжения работы пода ходя бы один том должен быть создан на основе pvc чей provisioner = "replicated.csi.storage.deckhouse.io"
5. Если работу с подом продолжать нельзя, на клиент возвращается ошибка
6. Вызывается метод filterNodes для отфильтровывания неподходящих для пода нод:
    - метод итерирует по именам нод-кандидатов
    - для каждого имени метод итерирует по всем переданным PVC
    - для каждой PVC:
        - метод получает StorageClass и проверяет его поле Spec.VolumeAccess
            - если VolumeAccess == "Local" (под нельзя размещать на нодах, где нет копии тома PVC):
                - если для PVC уже был выделен PV, нода-кандидат *НЕ* подойдет если она не является DRBD-нодой (CRD DRBDResource, обязательно diskful)
                - если PV выделен не был, нода-кандидат *НЕ* подойдет если:
                    - на ней не хватает места для томов пода
                    - на ней нет ни одной копии хотя бы одного тома PVC
            - если VolumeAccess == "EventuallyLocal"
                - PVC с выделенным PV, нода не подойдет:
                    - нет места
                    - нет ни одной копии томов PVC
                    - не DRBD-нода diskful
                - если PV нет, не подойдет нода:
                    - нет места
                    - нет ни одной копии томов PVC
            - если VolumeAccess == "EventuallyLocal"
                - если PV нет, не подойдут ноды на которых не хватает дискового места
                - если PV требований для фильтрации не предъявляется
        - Все ноды, прошедшие эти проверки будут проверены еще раз:
            - отфильтровываются не DRBD diskful ноды (на случай, если в проверках выше нода не проходила такую проверку)
            - также не подойдут offline-ноды

        - Любые ноды, прошедшие эти проверки признаются подходящими для размещения пода
    

        