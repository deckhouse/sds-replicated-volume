apiVersion: deckhouse.io/v1alpha1
kind: NodeGroupConfiguration
metadata:
  name: drbd-install-debian.sh
  {{- include "helm_lib_module_labels" (list .) | nindent 2 }}
spec:
  weight: 98
  nodeGroups: ["*"]
  bundles: ["ubuntu-lts", "debian", "astra"]
  content: |
    # Copyright 2023 Flant JSC
    #
    # Licensed under the Apache License, Version 2.0 (the "License");
    # you may not use this file except in compliance with the License.
    # You may obtain a copy of the License at
    #
    #     http://www.apache.org/licenses/LICENSE-2.0
    #
    # Unless required by applicable law or agreed to in writing, software
    # distributed under the License is distributed on an "AS IS" BASIS,
    # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    # See the License for the specific language governing permissions and
    # limitations under the License.

    # data nodes checksum to force bashible execution on nodes list change
    # {{ $.Values.sdsReplicatedVolume.internal.dataNodesChecksum }}

    # Unpack package from module image and run install script
    # bb-rp-from-module-image-install package:digest registry_auth scheme registry_address registry_path
    bb-rp-from-module-image-install() {
      local MODULE_PACKAGE=$1
      local REGISTRY_AUTH=$2
      local SCHEME=$3
      local REGISTRY_ADDRESS=$4
      local REGISTRY_PATH=$5

      bb-rp-install $MODULE_PACKAGE
    }

    kubeconfig="/etc/kubernetes/kubelet.conf"

    kernel_version_in_use="$(uname -r)"

    CLUSTER_DNS="{{ .Values.global.discovery.clusterDNSAddress }}"

    MODULE_REGISTRY_AUTH="$(echo {{ .Values.sdsReplicatedVolume.registry.dockercfg }} | base64 -d | jq -r '.auths[].auth // ""' | base64 -d)"
    {{- if or (hasPrefix "dev" .Values.global.deckhouseVersion) (hasSuffix "dev" .Values.global.deckhouseVersion) (semverCompare ">=1.58" .Values.global.deckhouseVersion) }}
    MODULE_SCHEME="{{ .Values.sdsReplicatedVolume.registry.scheme }}"
    {{- else }}
    MODULE_SCHEME="{{ .Values.sdsReplicatedVolume.registryScheme }}"
    {{- end }}
    MODULE_REGISTRY_ADDRESS=$(echo {{ .Values.sdsReplicatedVolume.registry.base }} | cut -f 1 -d '/')
    MODULE_REGISTRY_PATH="/"$(echo {{ .Values.sdsReplicatedVolume.registry.base }} | cut -f 2- -d '/')"/sds-replicated-volume"
    MODULE_REPOSITORY="{{ .Values.sdsReplicatedVolume.registry.base }}"

    is_master=$(bb-kubectl --kubeconfig $kubeconfig  get node "$(hostname)" -o json | jq -c '.metadata.labels | contains({"node-role.kubernetes.io/control-plane": ""})')
    if [ $is_master == "true" ]; then
      {{- if or (hasPrefix "dev" .Values.global.deckhouseVersion) (hasSuffix "dev" .Values.global.deckhouseVersion) (semverCompare ">=1.63" .Values.global.deckhouseVersion) }}
      bb-package-module-install "serviceScripts:{{ include "helm_lib_module_image_digest" (list . "serviceScripts" "sdsReplicatedVolume") }}" "$MODULE_REPOSITORY" "sds-replicated-volume"
      {{- else }}
      bb-rp-from-module-image-install "serviceScripts:{{ include "helm_lib_module_image_digest" (list . "serviceScripts" "sdsReplicatedVolume") }}" "$MODULE_REGISTRY_AUTH" "$MODULE_SCHEME" "$MODULE_REGISTRY_ADDRESS" "$MODULE_REGISTRY_PATH"
      {{- end }}
    fi

    is_linstor_data_node=$(bb-kubectl --kubeconfig $kubeconfig  get node "$(hostname)" -o json | jq -c '.metadata.labels | contains({"storage.deckhouse.io/sds-replicated-volume-node":""})')

    bb-log-info "we need drbd on node: "$is_linstor_data_node

    # Usermode helper has been disabled according to vendor recommendations. More information can be found here:
    # https://github.com/LINBIT/drbd/commit/819285d065f1f81bad7b97e32a64017b5e15948d
    # https://github.com/LINBIT/linstor-server/issues/121
    # https://github.com/piraeusdatastore/piraeus-operator/issues/134
    bb-sync-file /etc/modprobe.d/drbd.conf - << "EOF"
    options drbd usermode_helper=disabled
    EOF

    if [ $is_linstor_data_node == "false" ]; then
      if [ -e "/proc/drbd" ]; then
        if [ -e "/etc/modules" ]; then
          sed -i 's/^drbd$//' /etc/modules
        fi
        rmmod drbd_transport_rdma || true
        rmmod drbd_transport_tcp || true
        rmmod drbd || true
      fi
      # exit 0
    fi

    # DRBD requires the kernel sources to be installed.
    # Install actual kernel headers
    bb-apt-install "linux-headers-${kernel_version_in_use}"

    # Remove unused kernel-headers
    kernel_version_pattern="$(echo "$kernel_version_in_use" | sed -r 's/([0-9\.-]+)-([^0-9]+)$/^linux-headers-(\1|\1-\2)$/')"
    packages_to_remove="$(
      dpkg-query -S '/lib/modules/*/build' | awk -F: '{print $1}' | grep -Ev "$kernel_version_pattern" || true
    )"
    if [ -n "$packages_to_remove" ]; then
      bb-apt-remove $packages_to_remove
    fi

    if [ -e "/proc/drbd" ]; then
      # DRBD check version

      current_version="$(cat /proc/drbd | grep 'version:' | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')"
      desired_version="{{ $.Values.sdsReplicatedVolume.internal.drbdVersion }}"

      # We expect the loaded DRBD module to be version 9.
      # If version 8 is loaded, it means that for some reason, the in-tree kernel module has been automatically loaded.
      # (For example, this can happen due to drbd-utils installed on the host, which should not occur in standard scenarios).
      # We are only interested in the version 9 loaded by our helper script, so unload module and wait until it done.
      if [[ ! $current_version =~ ^9.* ]]; then
        rmmod drbd_transport_rdma || true
        rmmod drbd_transport_tcp || true
        rmmod drbd || true
      fi

      {{- if or (hasPrefix "dev" .Values.global.deckhouseVersion) (hasSuffix "dev" .Values.global.deckhouseVersion) (semverCompare ">=1.63" .Values.global.deckhouseVersion) }}
      bb-package-module-install "semver:{{ include "helm_lib_module_image_digest" (list . "semver" "sdsReplicatedVolume") }}" "$MODULE_REPOSITORY" "sds-replicated-volume"
      {{- else }}
      bb-rp-from-module-image-install "semver:{{ include "helm_lib_module_image_digest" (list . "semver" "sdsReplicatedVolume") }}" "$MODULE_REGISTRY_AUTH" "$MODULE_SCHEME" "$MODULE_REGISTRY_ADDRESS" "$MODULE_REGISTRY_PATH"
      {{- end }}

      if [ "$(d8-semver compare $current_version $desired_version)" == "-1" ]; then
        bb-log-info "DRBD needs to be rebuilt"
      else
        if [ -e "/etc/modules" ]; then
          if grep -q -E '^drbd$' /etc/modules; then
            sed -i '/^drbd$/d' /etc/modules
          fi
        fi
        bb-sync-file /etc/modules-load.d/d8_drbd.conf - <<< "drbd"

        bb-log-info "Desired drbd version is already loaded, nothing to do"
        #exit 0
      fi
    fi

    # Check, if we need gcc version 12
    gccVersion="$(cat /proc/version | grep -q x86_64-linux-gnu-gcc-12 && echo gcc-12 || echo gcc)"
    bb-apt-install make bind9-host patch mokutil $gccVersion
    check_sb_state="$(mokutil --sb-state || echo "Not supported")"
    if [[ "$check_sb_state" == "SecureBoot enabled" ]]; then
      bb-log-info "SecureBoot is enabled. Please manually install DRBD version  {{ $.Values.sdsReplicatedVolume.internal.drbdVersion }} or higher."
      #exit 0
    fi

    {{- if or (hasPrefix "dev" .Values.global.deckhouseVersion) (hasSuffix "dev" .Values.global.deckhouseVersion) (semverCompare ">=1.63" .Values.global.deckhouseVersion) }}
    bb-package-module-install "drbd:{{ include "helm_lib_module_image_digest" (list . "drbd" "sdsReplicatedVolume") }}" "$MODULE_REPOSITORY" "sds-replicated-volume"
    {{- else }}
    bb-rp-from-module-image-install "drbd:{{ include "helm_lib_module_image_digest" (list . "drbd" "sdsReplicatedVolume") }}" "$MODULE_REGISTRY_AUTH" "$MODULE_SCHEME" "$MODULE_REGISTRY_ADDRESS" "$MODULE_REGISTRY_PATH"
    {{- end }}

    cd /opt/deckhouse/drbd
    #-----------------------remote drbd modules build------------------------------------------
    bb-log-info "Get drbd-build-server url"

    DRBD_BUILD_SERVER_FQDN="drbd-build-server.d8-{{ .Chart.Name }}.svc.{{ .Values.global.discovery.clusterDomain }}"
    attempt=0
    bb-log-info "host -t A "DRBD_BUILD_SERVER_FQDN" "$CLUSTER_DNS"
    until DRBD_BUILD_SERVER_IP="$(host -t A "DRBD_BUILD_SERVER_FQDN" "$CLUSTER_DNS" | awk '/has address/ { print $4 }')"
    do
      if [ $attempt -gt 60 ]; then
        bb-log-info "Cluster DNS isn't accessible, can't get DRBD build server service IP for DRBD building"
        exit 1
      fi

      ((attempt=attempt+1))
      bb-log-info "Waiting for cluster DNS response (try #$attempt)"
      sleep 10
    done

    bb-log-info "Cluster DNS responded, got drbd-build-server service url"
    DRBD_BUILD_SERVER_URL="https://${DRBD_BUILD_SERVER_IP}:2021"

    KERNEL_VERSION=$kernel_version_in_use
    KERNEL_VERSION_SHORT="${KERNEL_VERSION%-generic}"
    bb-log-info "Detected kernel version: $KERNEL_VERSION"

    bb-log-info "Uploading kernel headers and starting build..."
    BUILD_RESPONSE=$(tar -czf - "/usr/src/linux-headers-${KERNEL_VERSION_SHORT}" "/usr/src/linux-headers-${KERNEL_VERSION_SHORT}-generic"|
        d8-curl -s -w "\n%{http_code}" -X POST \
          -H "Content-Type: application/gzip" \
          --data-binary @- \
          "$DRBD_BUILD_SERVER_URL/api/v1/build?kernel_version=${KERNEL_VERSION}" || echo -e "\n000")

    BUILD_HTTP_CODE=$(echo "$BUILD_RESPONSE" | tail -n1)
    BUILD_BODY=$(echo "$BUILD_RESPONSE" | sed '$d')

    # Accept both 200 OK and 202 Accepted from build endpoint
    if [ "$BUILD_HTTP_CODE" != "200" ] && [ "$BUILD_HTTP_CODE" != "202" ]; then
      if [ "$BUILD_HTTP_CODE" -eq 000 ]; then
        bb-log-error "Error: Failed to connect to build server"
      else
        bb-log-error "Error: Build request failed (HTTP $BUILD_HTTP_CODE): $BUILD_BODY"
      fi
      exit 1
    fi

    STATUS=$(echo "$BUILD_BODY" | jq -r '.status')
    JOB_ID=$(echo "$BUILD_BODY" | jq -r '.job_id')
    #DOWNLOAD_URL=null if emty
    DOWNLOAD_URL=$(echo "$BUILD_BODY" | jq -r '.download_url')

    bb-log-info "Downloading build artifacts..."
    BUILD_ARTIFACTS_TAR="./drbd-modules-${JOB_ID}.tar.gz"
    DOWNLOAD_RESPONSE=$(d8-curl -s -w "\n%{http_code}" -o "$BUILD_ARTIFACTS_TAR" \
      "${DRBD_BUILD_SERVER_URL}/api/v1/builds/${JOB_ID}" || echo -e "\n000")
    DOWNLOAD_HTTP_CODE=$(echo "$DOWNLOAD_RESPONSE" | tail -n1)

    if [ "$DOWNLOAD_HTTP_CODE" -ne 200 ]; then
      if [ "$DOWNLOAD_HTTP_CODE" -eq 000 ]; then
        bb-log-error "Error: Failed to connect to download endpoint"
      else
        bb-log-error "Error: Download failed (HTTP $DOWNLOAD_HTTP_CODE)"
        if [ -f "$BUILD_ARTIFACTS_TAR" ]; then
          # Check if the file contains an error message
          ERROR_MSG=$(head -20 "$BUILD_ARTIFACTS_TAR" 2>/dev/null || echo "")
          bb-log-error "Response: $ERROR_MSG"
          rm -f "$BUILD_ARTIFACTS_TAR"
        fi
      fi
      exit 1
    fi

    TAR_SIZE=$(du -h "$BUILD_ARTIFACTS_TAR" | cut -f1)
    bb-log-info "Downloaded build artifacts: $BUILD_ARTIFACTS_TAR (size: $TAR_SIZE)"

    # Extract the tar.gz
    EXTRACT_DIR="drbd-modules-${JOB_ID}"
    bb-log-info "Extracting to: $EXTRACT_DIR"
    mkdir -p "$EXTRACT_DIR"
    tar -xzf "$BUILD_ARTIFACTS_TAR" -C "$EXTRACT_DIR"

    if [ ! -d "$EXTRACT_DIR" ] || [ -z "$(ls -A "$EXTRACT_DIR" 2>/dev/null)" ]; then
      bb-log-error "Error: Extraction failed or directory is empty"
      exit 1
    fi
    bb-log-info "Extraction completed successfully"

    #for each .ko file exec insmod and report fails
    bb-log-info "Loading kernel modules..."
    KO_FILES=$(find "$EXTRACT_DIR" -type f -name "*.ko" | sort)

    if [ -z "$KO_FILES" ]; then
      bb-log-info "Warning: No .ko files found in $EXTRACT_DIR"
      exit 1
    fi

    SUCCESS_COUNT=0
    FAIL_COUNT=0
    FAILED_MODULES=()

    while IFS= read -r KO_FILE; do
      MODULE_NAME=$(basename "$KO_FILE" .ko)
      bb-log-info -n "Loading $MODULE_NAME... "

      # Try to load the module
      if echo "$KO_FILE" 2>/dev/null; then
        # if insmod "$KO_FILE" 2>/dev/null; then
        bb-log-info "OK"
        SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
      else
        ERROR_MSG=$(insmod "$KO_FILE" 2>&1 || true)
        bb-log-error "FAILED"
        bb-log-error "  Error: $ERROR_MSG"
        FAIL_COUNT=$((FAIL_COUNT + 1))
        FAILED_MODULES+=("$MODULE_NAME")
      fi
    done <<< "$KO_FILES"

    # Summary
    bb-log-info "Module loading summary:"
    bb-log-info "  Successfully loaded: $SUCCESS_COUNT"
    bb-log-info "  Failed: $FAIL_COUNT"

    if [ $FAIL_COUNT -gt 0 ]; then
      bb-log-info "Failed modules:"
      for MODULE in "${FAILED_MODULES[@]}"; do
        bb-log-info "  - $MODULE"
      done
      bb-log-info "Note: Some modules may have failed due to:"
      bb-log-info "  - Missing dependencies (load dependencies first)"
      bb-log-info "  - Module already loaded"
      bb-log-info "  - Insufficient permissions (run as root)"
      bb-log-info "  - Kernel version mismatch"
      exit 1
    else
      bb-log-info "All modules loaded successfully!"
    fi
    #------------------------------------------------------------------------------

    if [ -e "/etc/modules" ]; then
      if grep -q -E '^drbd$' /etc/modules; then
        sed -i '/^drbd$/d' /etc/modules
      fi
    fi
    bb-sync-file /etc/modules-load.d/d8_drbd.conf - <<< "drbd"
    depmod
    modprobe drbd
    modprobe dm-thin-pool

    if [ -e "/proc/drbd" ]; then
      current_version="$(cat /proc/drbd | grep 'version:' | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')"
      desired_version="{{ $.Values.sdsReplicatedVolume.internal.drbdVersion }}"

      {{- if or (hasPrefix "dev" .Values.global.deckhouseVersion) (hasSuffix "dev" .Values.global.deckhouseVersion) (semverCompare ">=1.63" .Values.global.deckhouseVersion) }}
      bb-package-module-install "semver:{{ include "helm_lib_module_image_digest" (list . "semver" "sdsReplicatedVolume") }}" "$MODULE_REPOSITORY" "sds-replicated-volume"
      {{- else }}
      bb-rp-from-module-image-install "semver:{{ include "helm_lib_module_image_digest" (list . "semver" "sdsReplicatedVolume") }}" "$MODULE_REGISTRY_AUTH" "$MODULE_SCHEME" "$MODULE_REGISTRY_ADDRESS" "$MODULE_REGISTRY_PATH"
      {{- end }}

      if [ "$(d8-semver compare $current_version $desired_version)" == "-1" ]; then
        bb-log-info "Non-actual version of drbd is loaded (now "$current_version", desired minimum "$desired_version"), setting reboot flag"
        bb-flag-set reboot
      fi
    fi
