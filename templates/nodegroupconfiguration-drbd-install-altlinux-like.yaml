apiVersion: deckhouse.io/v1alpha1
kind: NodeGroupConfiguration
metadata:
  name: drbd-install-altlinux.sh
  {{- include "helm_lib_module_labels" (list .) | nindent 2 }}
spec:
  weight: 98
  nodeGroups: ["*"]
  bundles: ["altlinux"]
  content: |
    # Copyright 2023 Flant JSC
    #
    # Licensed under the Apache License, Version 2.0 (the "License");
    # you may not use this file except in compliance with the License.
    # You may obtain a copy of the License at
    #
    #     http://www.apache.org/licenses/LICENSE-2.0
    #
    # Unless required by applicable law or agreed to in writing, software
    # distributed under the License is distributed on an "AS IS" BASIS,
    # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    # See the License for the specific language governing permissions and
    # limitations under the License.

    # data nodes checksum to force bashible execution on nodes list change
    # {{ $.Values.sdsReplicatedVolume.internal.dataNodesChecksum }}

    # Unpack package from module image and run install script
    # bb-rp-from-module-image-install package:digest registry_auth scheme registry_address registry_path
    bb-rp-from-module-image-install() {
      local MODULE_PACKAGE=$1
      local REGISTRY_AUTH=$2
      local SCHEME=$3
      local REGISTRY_ADDRESS=$4
      local REGISTRY_PATH=$5

      bb-rp-install $MODULE_PACKAGE
    }

    kubeconfig="/etc/kubernetes/kubelet.conf"

    kernel_version_in_use="$(uname -r)"

    CLUSTER_DNS="{{ .Values.global.discovery.clusterDNSAddress }}"
    DRBD_BUILD_SERVER_FQDN="drbd-build-server.d8-{{ .Chart.Name }}.svc.{{ .Values.global.discovery.clusterDomain }}"

    MODULE_REGISTRY_AUTH="$(echo {{ .Values.sdsReplicatedVolume.registry.dockercfg }} | base64 -d | jq -r '.auths[].auth // ""' | base64 -d)"
    {{- if or (hasPrefix "dev" .Values.global.deckhouseVersion) (hasSuffix "dev" .Values.global.deckhouseVersion) (semverCompare ">=1.58" .Values.global.deckhouseVersion) }}
    MODULE_SCHEME="{{ .Values.sdsReplicatedVolume.registry.scheme }}"
    {{- else }}
    MODULE_SCHEME="{{ .Values.sdsReplicatedVolume.registryScheme }}"
    {{- end }}
    MODULE_REGISTRY_ADDRESS=$(echo {{ .Values.sdsReplicatedVolume.registry.base }} | cut -f 1 -d '/')
    MODULE_REGISTRY_PATH="/"$(echo {{ .Values.sdsReplicatedVolume.registry.base }} | cut -f 2- -d '/')"/sds-replicated-volume"
    MODULE_REPOSITORY="{{ .Values.sdsReplicatedVolume.registry.base }}"

    is_master=$(bb-kubectl --kubeconfig $kubeconfig  get node "$(hostname)" -o json | jq -c '.metadata.labels | contains({"node-role.kubernetes.io/control-plane": ""})')
    if [ $is_master == "true" ]; then
      {{- if or (hasPrefix "dev" .Values.global.deckhouseVersion) (hasSuffix "dev" .Values.global.deckhouseVersion) (semverCompare ">=1.63" .Values.global.deckhouseVersion) }}
      bb-package-module-install "serviceScripts:{{ include "helm_lib_module_image_digest" (list . "serviceScripts" "sdsReplicatedVolume") }}" "$MODULE_REPOSITORY" "sds-replicated-volume"
      {{- else }}
      bb-rp-from-module-image-install "serviceScripts:{{ include "helm_lib_module_image_digest" (list . "serviceScripts" "sdsReplicatedVolume") }}" "$MODULE_REGISTRY_AUTH" "$MODULE_SCHEME" "$MODULE_REGISTRY_ADDRESS" "$MODULE_REGISTRY_PATH"
      {{- end }}
    fi

    is_linstor_data_node=$(bb-kubectl --kubeconfig $kubeconfig  get node "$(hostname)" -o json | jq -c '.metadata.labels | contains({"storage.deckhouse.io/sds-replicated-volume-node":""})')

    bb-log-info "we need drbd on node: "$is_linstor_data_node

    # Usermode helper has been disabled according to vendor recommendations. More information can be found here:
    # https://github.com/LINBIT/drbd/commit/819285d065f1f81bad7b97e32a64017b5e15948d
    # https://github.com/LINBIT/linstor-server/issues/121
    # https://github.com/piraeusdatastore/piraeus-operator/issues/134
    bb-sync-file /etc/modprobe.d/drbd.conf - << "EOF"
    options drbd usermode_helper=disabled
    EOF

    if [ $is_linstor_data_node == "false" ]; then
      if [ -e "/proc/drbd" ]; then
        if [ -e "/etc/modules" ]; then
          sed -i 's/^drbd$//' /etc/modules
        fi
        rmmod drbd_transport_rdma || true
        rmmod drbd_transport_tcp || true
        rmmod drbd || true
      fi
      exit 0
    fi

    # DRBD requires the kernel sources to be installed.
    # Install actual kernel headers. It can be different from current kernel version!
    # So further we check, if we need new kernel version. It is altlinux feature.
    apt-get update
    apt-get -y install kernel-headers-modules-std-def

    if [ ! -e "/lib/modules/$kernel_version_in_use/build" ]; then
      update-kernel -y
      bb-flag-set reboot
      exit 0
    fi

    if [ -e "/proc/drbd" ]; then
      # DRBD check version

      current_version="$(cat /proc/drbd | grep 'version:' | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')"
      desired_version="$DRBD_VERSION"

      # We expect the loaded DRBD module to be version 9.
      # If version 8 is loaded, it means that for some reason, the in-tree kernel module has been automatically loaded.
      # (For example, this can happen due to drbd-utils installed on the host, which should not occur in standard scenarios).
      # We are only interested in the version 9 loaded by our helper script, so unload module and wait until it done.
      if [[ ! $current_version =~ ^9.* ]]; then
        rmmod drbd_transport_rdma || true
        rmmod drbd_transport_tcp || true
        rmmod drbd || true
      fi

      {{- if or (hasPrefix "dev" .Values.global.deckhouseVersion) (hasSuffix "dev" .Values.global.deckhouseVersion) (semverCompare ">=1.63" .Values.global.deckhouseVersion) }}
      bb-package-module-install "semver:{{ include "helm_lib_module_image_digest" (list . "semver" "sdsReplicatedVolume") }}" "$MODULE_REPOSITORY" "sds-replicated-volume"
      {{- else }}
      bb-rp-from-module-image-install "semver:{{ include "helm_lib_module_image_digest" (list . "semver" "sdsReplicatedVolume") }}" "$MODULE_REGISTRY_AUTH" "$MODULE_SCHEME" "$MODULE_REGISTRY_ADDRESS" "$MODULE_REGISTRY_PATH"
      {{- end }}

      if [ "$(d8-semver compare $current_version $desired_version)" == "-1" ]; then
        bb-log-info "DRBD needs to be rebuilt"
      else
        if [ -e "/etc/modules" ]; then
          if grep -q -E '^drbd$' /etc/modules; then
            sed -i '/^drbd$/d' /etc/modules
          fi
        fi
        bb-sync-file /etc/modules-load.d/d8_drbd.conf - <<< "drbd"

        bb-log-info "Desired drbd version is already loaded, nothing to do"
        exit 0
      fi
    fi

    # Install curl for API calls
    apt-get -y install curl bind-utils

    attempt=0
    until DRBD_BUILD_SERVER_IP="$(host -t A "$DRBD_BUILD_SERVER_FQDN" "$CLUSTER_DNS" | awk '/has address/ { print $4 }')"
    do
      if [ $attempt -gt 60 ]; then
        bb-log-info "Cluster DNS isn't accessible, can't get DRBD build server service IP"
        exit 1
      fi

      ((attempt=attempt+1))
      bb-log-info "Waiting for cluster DNS response (try #$attempt)"
      sleep 10
    done

    bb-log-info "Cluster DNS responded, got DRBD build server service IP"

    DRBD_BUILD_SERVER_URL="http://${DRBD_BUILD_SERVER_IP}:2021"

    attempt=0
    until [[ "$(curl -ks -w '%{http_code}' -o /dev/null $DRBD_BUILD_SERVER_URL'/api/v1/hello')" == "200" ]]
    do
      if [ $attempt -gt 60 ]; then
        bb-log-info "DRBD build server isn't accessible, can't continue DRBD building"
        exit 1
      fi

      ((attempt=attempt+1))
      bb-log-info "Waiting for DRBD build server to be accessible (try #$attempt)"
      sleep 10
    done

    bb-log-info "DRBD build server is accessible, starting DRBD building"

    # Find kernel headers directories
    # In AltLinux, archive all /usr/src/linux-headers-* directories (all versions)
    KERNEL_VERSION_FOR_API="${kernel_version_in_use}"
    DRBD_VERSION="{{ $.Values.sdsReplicatedVolume.drbdVersion }}"
    MODULES_TAR="/tmp/drbd-modules-${kernel_version_in_use}.tar.gz"
    
    # Archive kernel headers and send build request
    bb-log-info "Sending build request to DRBD build server"
    
    # Check if there are kernel headers in /usr/src/
    if ls -d /usr/src/linux-headers-* >/dev/null 2>&1; then
      HEADERS_DIRS=$(ls -d /usr/src/linux-headers-* 2>/dev/null)
      
      # If flavor-specific directory exists for current kernel (e.g., -generic), use it for API version
      if [ -d "/usr/src/linux-headers-${kernel_version_in_use}-generic" ]; then
        KERNEL_VERSION_FOR_API="${kernel_version_in_use}-generic"
      fi
      
      bb-log-info "Found kernel headers directories: $HEADERS_DIRS"
      bb-log-info "Archiving all /usr/src/linux-headers-* directories"
      
      # Archive all linux-headers directories, try with --hard-dereference first, then fallback without it if it fails
      if ! tar --hard-dereference -chzf /tmp/headers.tar.gz /usr/src/linux-headers-* 2>/dev/null; then
        bb-log-info "tar with --hard-dereference failed, retrying without it"
        tar --hard-dereference -czf /tmp/headers.tar.gz /usr/src/linux-headers-*
      fi

      HTTP_CODE=$(curl -s -w '%{http_code}' -X POST \
        -H "Content-Type: application/gzip" \
        -H "X-Kernel-Version: ${KERNEL_VERSION_FOR_API}" \
        -H "X-DRBD-Version: ${DRBD_VERSION}" \
        --data-binary @/tmp/headers.tar.gz \
        -o "$MODULES_TAR" \
        "$DRBD_BUILD_SERVER_URL/api/v1/build?kernel_version=${KERNEL_VERSION_FOR_API}&drbd_version=${DRBD_VERSION}")
      
      # Cleanup temporary headers archive
      rm -f /tmp/headers.tar.gz
    elif [ -d "/lib/modules/${kernel_version_in_use}/build" ]; then
      # Fallback: use /lib/modules/.../build
      KERNEL_HEADERS_DIR="$(readlink -f "/lib/modules/${kernel_version_in_use}/build")"
      bb-log-info "Using kernel headers from /lib/modules via symlink: $KERNEL_HEADERS_DIR"
      
      # Archive kernel headers directory
      if ! tar --hard-dereference -chzf /tmp/headers.tar.gz "$KERNEL_HEADERS_DIR" 2>/dev/null; then
        tar --hard-dereference -czf /tmp/headers.tar.gz "$KERNEL_HEADERS_DIR"
      fi
      
      HTTP_CODE=$(curl -s -w '%{http_code}' -X POST \
        -H "Content-Type: application/gzip" \
        -H "X-Kernel-Version: ${KERNEL_VERSION_FOR_API}" \
        -H "X-DRBD-Version: ${DRBD_VERSION}" \
        --data-binary @/tmp/headers.tar.gz \
        -o "$MODULES_TAR" \
        "$DRBD_BUILD_SERVER_URL/api/v1/build?kernel_version=${KERNEL_VERSION_FOR_API}&drbd_version=${DRBD_VERSION}")
      
      # Cleanup temporary headers archive
      rm -f /tmp/headers.tar.gz
    else
      bb-log-info "Kernel headers directory not found for version ${kernel_version_in_use}"
      exit 1
    fi

    if [ "$HTTP_CODE" == "200" ]; then
      # Modules were served directly from cache
      bb-log-info "Modules retrieved from cache"
    elif [ "$HTTP_CODE" == "202" ]; then
      # Build job was created, need to poll for status
      BUILD_RESPONSE=$(cat "$MODULES_TAR")
      rm -f "$MODULES_TAR"
      
      JOB_ID=$(echo "$BUILD_RESPONSE" | jq -r '.job_id // empty')
      if [ -z "$JOB_ID" ]; then
        bb-log-info "Failed to get job_id from build server response: $BUILD_RESPONSE"
        exit 1
      fi

      bb-log-info "Build job created, job_id: $JOB_ID"

      # Poll for build status
      attempt=0
      while true; do
        if [ $attempt -gt 300 ]; then
          bb-log-info "Build timeout exceeded (50 minutes)"
          exit 1
        fi

        STATUS_RESPONSE=$(curl -s "$DRBD_BUILD_SERVER_URL/api/v1/status/$JOB_ID")
        STATUS=$(echo "$STATUS_RESPONSE" | jq -r '.status // empty')
        ERROR=$(echo "$STATUS_RESPONSE" | jq -r '.error // empty')

        if [ "$STATUS" == "completed" ]; then
          bb-log-info "Build completed successfully"
          break
        elif [ "$STATUS" == "failed" ]; then
          bb-log-info "Build failed: $ERROR"
          exit 1
        elif [ "$STATUS" == "building" ] || [ "$STATUS" == "pending" ]; then
          ((attempt=attempt+1))
          if [ $((attempt % 6)) -eq 0 ]; then
            bb-log-info "Build in progress (status: $STATUS, attempt #$attempt)"
          fi
          sleep 10
        else
          bb-log-info "Unknown build status: $STATUS"
          exit 1
        fi
      done

      # Download built modules
      bb-log-info "Downloading built DRBD modules"
      curl -s -o "$MODULES_TAR" "$DRBD_BUILD_SERVER_URL/api/v1/download/$JOB_ID"
    else
      bb-log-info "Unexpected HTTP code from build server: $HTTP_CODE"
      exit 1
    fi

    if [ ! -f "$MODULES_TAR" ] || [ ! -s "$MODULES_TAR" ]; then
      bb-log-info "Failed to download DRBD modules"
      exit 1
    fi

    # Extract and install modules
    bb-log-info "Installing DRBD modules"
    MODULES_DIR="/tmp/drbd-modules-${kernel_version_in_use}"
    mkdir -p "$MODULES_DIR"
    if ! tar -xzf "$MODULES_TAR" -C "$MODULES_DIR"; then
      bb-log-info "Failed to extract DRBD modules archive"
      exit 1
    fi

    # Find and copy .ko files to /lib/modules
    # The archive contains modules with relative paths from the build output
    MODULES_DEST="/lib/modules/${kernel_version_in_use}/kernel/drivers/block"
    mkdir -p "$MODULES_DEST"
    
    # Find all .ko files in the extracted archive and copy them to the destination
    KO_COUNT=0
    while IFS= read -r ko_file; do
      cp "$ko_file" "$MODULES_DEST/"
      bb-log-info "Installed module: $(basename "$ko_file")"
      KO_COUNT=$((KO_COUNT + 1))
    done < <(find "$MODULES_DIR" -name "*.ko" -type f)
    
    if [ "$KO_COUNT" -eq 0 ]; then
      bb-log-info "No .ko files found in the downloaded archive"
      exit 1
    fi
    
    bb-log-info "Installed $KO_COUNT DRBD module(s)"

    if [ -e "/etc/modules" ]; then
      if grep -q -E '^drbd$' /etc/modules; then
        sed -i '/^drbd$/d' /etc/modules
      fi
    fi
    bb-sync-file /etc/modules-load.d/d8_drbd.conf - <<< "drbd"
    depmod
    modprobe drbd
    modprobe dm-thin-pool

    # Cleanup
    rm -rf "$MODULES_DIR" "$MODULES_TAR"

    if [ -e "/proc/drbd" ]; then
      current_version="$(cat /proc/drbd | grep 'version:' | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')"
      desired_version="$DRBD_VERSION"

      {{- if or (hasPrefix "dev" .Values.global.deckhouseVersion) (hasSuffix "dev" .Values.global.deckhouseVersion) (semverCompare ">=1.63" .Values.global.deckhouseVersion) }}
      bb-package-module-install "semver:{{ include "helm_lib_module_image_digest" (list . "semver" "sdsReplicatedVolume") }}" "$MODULE_REPOSITORY" "sds-replicated-volume"
      {{- else }}
      bb-rp-from-module-image-install "semver:{{ include "helm_lib_module_image_digest" (list . "semver" "sdsReplicatedVolume") }}" "$MODULE_REGISTRY_AUTH" "$MODULE_SCHEME" "$MODULE_REGISTRY_ADDRESS" "$MODULE_REGISTRY_PATH"
      {{- end }}

      if [ "$(d8-semver compare $current_version $desired_version)" == "-1" ]; then
        bb-log-info "Non-actual version of drbd is loaded (now "$current_version", desired minimum "$desired_version"), setting reboot flag"
        bb-flag-set reboot
      fi
    fi
